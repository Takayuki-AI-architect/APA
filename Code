<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Apocrypha Prompt Architect (APA) v0.8</title>
  <style>
    :root{
      --bg-color:#1a1b26; --card-bg:#24283b; --accent:#7aa2f7;
      --text-main:#c0caf5; --text-dim:#565f89; --border:#414868;
      --alert:#f7768e; --success:#9ece6a; --copy-btn:#bb9af7; --warn-bg: #e0af68;
      --manage-bg: #1f2335;
    }
    body{font-family:'Segoe UI',sans-serif;background:var(--bg-color);color:var(--text-main);
      margin:0;padding:20px;display:flex;justify-content:center;}
    .container{width:100%;max-width:940px;background:var(--card-bg);padding:30px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.5);}
    h1{margin:0 0 10px;border-bottom:1px solid var(--border);padding-bottom:10px;font-size:1.5rem;display:flex;align-items:center;justify-content:space-between;}
    .row{display:flex;gap:15px;flex-wrap:wrap;}
    .col{flex:1;min-width:280px;}
    .section{margin-bottom:18px;padding:15px;background:rgba(0,0,0,.2);border-radius:8px;border:1px solid var(--border);}
    .section-title{font-size:.9rem;color:var(--accent);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;
      display:flex;justify-content:space-between;align-items:center;gap:10px;}
    
    input[type="text"], select, textarea{
      width:100%;padding:12px;background:var(--bg-color);border:1px solid var(--border);
      color:var(--text-main);border-radius:6px;box-sizing:border-box;font-size:1rem;
    }
    input[type="text"]:focus, textarea:focus, select:focus{outline:none;border-color:var(--accent);}
    
    .apocrypha-log{font-family:'Consolas',monospace;font-size:.85rem;color:var(--success);margin-bottom:10px;min-height:1.2em;}
    .apocrypha-log.warning{color:var(--alert);}
    
    .tag-container{display:flex;flex-wrap:wrap;gap:8px;}
    .tag-checkbox{display:none;}
    .tag-label{
      background:var(--bg-color);border:1px solid var(--border);
      padding:6px 12px;border-radius:20px;cursor:pointer;font-size:.85rem;
      transition:all .2s;user-select:none;
    }
    .tag-checkbox:checked + .tag-label{background:var(--accent);color:#1a1b26;border-color:var(--accent);font-weight:bold;}
    
    button.generate-btn{
      width:100%;padding:16px;background:var(--accent);color:#fff;border:none;border-radius:6px;
      font-size:1.1rem;font-weight:bold;cursor:pointer;transition:all .2s;margin-bottom:18px;
    }
    button.generate-btn:hover{filter: brightness(1.1); transform: translateY(-1px);}
    
    .output-group{margin-bottom:15px;}
    .output-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:.85rem;color:var(--text-dim);}
    .copy-btn{
      background:var(--copy-btn);color:#1a1b26;border:none;padding:6px 14px;border-radius:4px;
      cursor:pointer;font-size:.85rem;font-weight:bold;transition:all 0.2s;min-width: 80px;text-align: center;
    }
    .copy-btn:hover{filter: brightness(1.1);}
    .copy-btn.copied{background:var(--success) !important; color:#1a1b26;}

    .output-area{height:100px;font-family:ui-monospace, Consolas, monospace;font-size:.9rem;resize: vertical;}
    .mini{font-size:.8rem;color:var(--text-dim);line-height:1.4;}
    .pill{padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:.75rem;color:var(--text-dim);}
    .tier-pill { padding: 1px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; background: var(--border); color: var(--text-main); }
    .tier-1 { background: #f7768e; color: #fff; }
    .tier-2 { background: #e0af68; color: #1a1b26; }
    .tier-3 { background: #7aa2f7; color: #fff; }

    .btn-inline{padding:6px 10px;border-radius:4px;border:1px solid var(--border);background:var(--bg-color);color:var(--text-main);cursor:pointer;font-size: 0.8rem;}
    .btn-inline:hover{border-color:var(--accent); color:var(--accent);}

    /* Management Area */
    details.manager { margin-top: 25px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
    summary { cursor: pointer; padding: 12px; background: rgba(255,255,255,0.05); color: var(--text-main); font-size: 0.9rem; font-weight: bold; }
    .manager-inner { padding: 15px; background: var(--manage-bg); display: flex; flex-direction: column; gap: 20px; }
    .list-container { max-height: 180px; overflow-y: auto; background: var(--bg-color); border: 1px solid var(--border); border-radius: 6px; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
    .list-item:hover { background: rgba(255,255,255,0.02); }
    
    .history { font-size: 0.8rem; color: var(--text-dim); line-height: 1.6; padding: 10px; border-top: 1px solid var(--border); }
    .tab-nav { display: flex; gap: 5px; margin-bottom: 10px; border-bottom: 1px solid var(--border); }
    .tab-btn { padding: 8px 15px; background: none; border: none; color: var(--text-dim); cursor: pointer; border-bottom: 2px solid transparent; font-size: 0.85rem; }
    .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
  </style>
</head>
<body>
<div class="container">
  <h1>
    Apocrypha Prompt Architect 
    <span class="pill">v0.8 (Toolkit)</span>
  </h1>

  <!-- Step 1 -->
  <div class="section">
    <div class="section-title">
      <span>Step 1: Core Concept</span>
      <span class="mini"><kbd style="font-family:sans-serif; border:1px solid var(--border); padding:2px 5px; border-radius:4px;">Ctrl+Enter</kbd> to Generate</span>
    </div>
    <div id="status-bar" class="apocrypha-log">Ready.</div>
    <input type="text" id="core-input" placeholder="ä¾‹: ç¥ç¤¾ã®å¢ƒå†…ã§ç­†ã‚’æŒã¤å·«å¥³ã®å¥³æ€§" autocomplete="off">
  </div>

  <div class="row">
    <!-- Step 2 -->
    <div class="section col">
      <div class="section-title">
        <span>Step 2: Cultural Contexts</span>
        <select id="context-select" style="width: auto; padding: 4px 8px; font-size: 0.8rem;"><option value="auto">Auto Select</option></select>
      </div>
      <div id="tier-display" style="margin-bottom: 10px; display: flex; gap: 5px; flex-wrap: wrap;"></div>
      <div class="tag-container" id="tag-suggestions">
        <span class="mini" style="font-style:italic;">å…¥åŠ›ã«åŸºã¥ã„ã¦æ–‡è„ˆã‚’è‡ªå‹•æ¤œçŸ¥ã—ã¾ã™...</span>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="section col">
      <div class="section-title"><span>Step 3: Quality & Logic</span></div>
      
      <div class="row" style="gap:10px;">
        <div style="flex:1;">
          <label class="mini">Quality Preset</label>
          <select id="quality-select">
            <option value="standard">Standard</option>
            <option value="high">High</option>
            <option value="god" selected>God Mode</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="mini">Hand Stabilizer</label>
          <select id="hand-fix-select">
            <option value="none">None</option>
            <option value="auto" selected>Auto</option>
            <option value="hold">Hold</option>
            <option value="hide">Hide</option>
          </select>
        </div>
      </div>
      <div id="hand-fix-hint" class="mini" style="margin-top:8px; color:var(--warn-bg); min-height:1.2em;"></div>

      <div style="margin-top:12px; display:flex; gap:15px;">
        <label class="mini" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="check-nsfw" checked> NSFW Negative
        </label>
        <label class="mini" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
          <input type="checkbox" id="check-keep-en" checked> Keep English
        </label>
      </div>
    </div>
  </div>

  <button class="generate-btn" id="btn-generate">GENERATE APOCRYPHA PROMPT</button>

  <!-- Output -->
  <div class="section">
    <div class="output-group">
      <div class="output-header"><span>POSITIVE PROMPT</span><button class="copy-btn" data-target="out-pos">COPY</button></div>
      <textarea id="out-pos" class="output-area" readonly></textarea>
    </div>
    <div class="output-group">
      <div class="output-header"><span style="color:var(--alert);">NEGATIVE PROMPT</span><button class="copy-btn" style="background:var(--alert);" data-target="out-neg">COPY</button></div>
      <textarea id="out-neg" class="output-area" style="height:60px; border-color:var(--alert);" readonly></textarea>
    </div>
    <div id="stats-info" class="mini" style="text-align: right;"></div>
  </div>

  <!-- Manager -->
  <details class="manager">
    <summary>ğŸ›ï¸ Management Hub (Contexts & Dictionary)</summary>
    <div class="manager-inner">
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="tab-ctx">Contexts</button>
        <button class="tab-btn" data-tab="tab-dict">Translation Map</button>
        <button class="tab-btn" data-tab="tab-io">Import/Export</button>
      </div>

      <!-- Tab: Contexts -->
      <div id="tab-ctx" class="tab-content active">
        <div class="mini" style="margin-bottom:8px;">ç¾åœ¨ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹æ–‡åŒ–èƒŒæ™¯ï¼ˆContextï¼‰ä¸€è¦§:</div>
        <div class="list-container" id="list-ctx"></div>
      </div>

      <!-- Tab: Dictionary -->
      <div id="tab-dict" class="tab-content">
        <div class="row" style="margin-bottom:10px;">
          <div class="col"><input type="text" id="dict-in-jp" placeholder="æ—¥æœ¬èªã‚­ãƒ¼" style="padding:8px;"></div>
          <div class="col"><input type="text" id="dict-in-en" placeholder="è‹±èªã‚¿ã‚°" style="padding:8px;"></div>
          <button class="btn-inline" id="btn-add-dict" style="height:36px;">Add</button>
        </div>
        <div class="list-container" id="list-dict"></div>
      </div>

      <!-- Tab: IO -->
      <div id="tab-io" class="tab-content">
        <textarea id="io-json" class="output-area" style="height:120px; font-size:0.75rem;" placeholder="JSONã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘..."></textarea>
        <div class="row" style="margin-top:10px;">
          <button class="btn-inline" id="btn-import-all" style="flex:1;">Import All Data</button>
          <button class="btn-inline" id="btn-export-all" style="flex:1; border-color:var(--copy-btn); color:var(--copy-btn);">Export All Data</button>
          <button class="btn-inline" id="btn-reset-factory" style="border-color:var(--alert); color:var(--alert);">Factory Reset</button>
        </div>
      </div>

      <!-- ChangeLog -->
      <div class="history">
        <b>v0.8 Changes:</b><br>
        - 21ç¨®é¡ã®å…¨æ–‡åŒ–èƒŒæ™¯ã«æ‰‹ãƒãƒ¼ã‚ºã®æœ€é©åŒ–(handFix)ã‚’é©ç”¨<br>
        - æ—¥æœ¬èªâ†’è‹±èªè¾æ›¸ã®ç®¡ç†ç”»é¢ã‚’çµ±åˆã€‚å‹•çš„ã«è¿½åŠ ãƒ»ç·¨é›†ãŒå¯èƒ½<br>
        - è¤‡æ•°æ–‡åŒ–æ¤œå‡ºæ™‚ã®Tierå„ªå…ˆåº¦ã‚’UIã«è¡¨ç¤º<br>
        - å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ+è¾æ›¸ï¼‰ã®ä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’è¿½åŠ 
      </div>
    </div>
  </details>
</div>

<script>
  // --- Constants & Defaults ---
  const DEFAULT_CONTEXTS = [
    { id: "ctx_miko", triggers: ["å·«å¥³", "ç¥ç¤¾", "é³¥å±…", "ãŠã¿ãã˜", "éˆ´", "miko", "shrine maiden"], tier: 1, tierName: "Shrine Maiden", tags: [{id:"m1",label:"å·«å¥³è£…æŸ",tag:"miko, hakama, white kosode, red hakama, tabi",active:true}], handFix: {auto:"praying hands", hold:"holding kagura suzu", hide:"hands in sleeves"}, negativeAdditions: ["neon", "robot", "gun"] },
    { id: "ctx_kyudo", triggers: ["å¼“é“", "å¼“", "çŸ¢", "é“å ´", "kyudo", "archery"], tier: 1, tierName: "Kyudo", tags: [{id:"k1",label:"å¼“é“ç€",tag:"kyudo uniform, hakama",active:true}], handFix: {auto:"drawing bow", hold:"holding japanese bow", hide:"hands behind back"}, negativeAdditions: ["gun", "neon"] },
    { id: "ctx_yukata", triggers: ["å¤ç¥­ã‚Š", "æµ´è¡£", "èŠ±ç«", "yukata", "festival"], tier: 2, tierName: "Summer Festival", tags: [{id:"y1",label:"æµ´è¡£",tag:"yukata, floral print",active:true}], handFix: {auto:"holding fan", hold:"holding apple candy", hide:"hands in sleeves"}, negativeAdditions: ["snow", "winter"] },
    { id: "ctx_hanami", triggers: ["ãŠèŠ±è¦‹", "æ¡œ", "sakura", "cherry blossom"], tier: 2, tierName: "Hanami", tags: [{id:"h1",label:"æ¡œ",tag:"cherry blossoms, sakura trees",active:true}], handFix: {auto:"sitting on sheet", hold:"holding sake cup", hide:"hands on lap"}, negativeAdditions: ["pumpkin", "snow"] },
    { id: "ctx_kendo", triggers: ["å‰£é“", "ç«¹åˆ€", "è¢´", "kendo"], tier: 1, tierName: "Kendo", tags: [{id:"kd1",label:"é˜²å…·",tag:"kendo uniform, bogu",active:true}], handFix: {auto:"kendo stance", hold:"holding shinai with both hands", hide:"hands behind back"}, negativeAdditions: ["wand", "wings"] },
    { id: "ctx_medieval_noble", triggers: ["ä¸­ä¸–", "åŸ", "è²´æ—", "ãƒ‰ãƒ¬ã‚¹", "medieval", "castle", "noble"], tier: 2, tierName: "Medieval Noble", tags: [{id:"n1",label:"ä¸­ä¸–ãƒ‰ãƒ¬ã‚¹",tag:"medieval gown, corset",active:true}], handFix: {auto:"elegant standing", hold:"holding fan", hide:"hands folded"}, negativeAdditions: ["neon", "robot", "tatami"] },
    { id: "ctx_magical_girl", triggers: ["é­”æ³•å°‘å¥³", "æ–", "magical girl"], tier: 3, tierName: "Magical Girl", tags: [{id:"mg1",label:"é­”æ³•å°‘å¥³è£…",tag:"frilled dress, ribbons",active:true}], handFix: {auto:"transformation pose", hold:"holding wand high", hide:"hands behind back"}, negativeAdditions: ["blood", "gun"] },
    { id: "ctx_military", triggers: ["è»æœ", "å°†æ ¡", "military", "officer"], tier: 2, tierName: "Military", tags: [{id:"mi1",label:"è»æœ",tag:"military uniform, peaked cap",active:true}], handFix: {auto:"salute", hold:"holding riding crop", hide:"hands behind back"}, negativeAdditions: ["ribbon", "wand"] },
    { id: "ctx_maid", triggers: ["ãƒ¡ã‚¤ãƒ‰", "maid"], tier: 3, tierName: "Maid Cafe", tags: [{id:"md1",label:"ãƒ¡ã‚¤ãƒ‰æœ",tag:"maid outfit, apron",active:true}], handFix: {auto:"welcome pose", hold:"holding tray", hide:"hands behind back"}, negativeAdditions: ["blood", "traditional"] },
    { id: "ctx_goth_loli", triggers: ["ã‚´ã‚¹ãƒ­ãƒª", "ãƒ­ãƒªãƒ¼ã‚¿", "lolita"], tier: 3, tierName: "Goth-Loli", tags: [{id:"gl1",label:"ã‚´ã‚¹ãƒ­ãƒªæœ",tag:"gothic lolita dress",active:true}], handFix: {auto:"elegant pose", hold:"holding parasol", hide:"hands folded"}, negativeAdditions: ["sneakers", "gun"] },
    { id: "ctx_beach", triggers: ["æµ·", "ãƒ“ãƒ¼ãƒ", "æ°´ç€", "beach", "swimsuit"], tier: 3, tierName: "Beach", tags: [{id:"b1",label:"æ°´ç€",tag:"bikini, swimsuit",active:true}], handFix: {auto:"stretching arms", hold:"holding beach ball", hide:"hands behind head"}, negativeAdditions: ["tatami", "snow"] },
    { id: "ctx_christmas", triggers: ["ã‚¯ãƒªã‚¹ãƒã‚¹", "é›ª", "christmas", "santa"], tier: 3, tierName: "Christmas", tags: [{id:"c1",label:"ã‚µãƒ³ã‚¿æœ",tag:"santa hat, red dress",active:true}], handFix: {auto:"praying pose", hold:"holding gift", hide:"hands in mittens"}, negativeAdditions: ["fireworks", "yukata"] },
    { id: "ctx_ninja", triggers: ["å¿è€…", "ninja", "shinobi"], tier: 2, tierName: "Ninja", tags: [{id:"nj1",label:"å¿è£…æŸ",tag:"ninja outfit, kunai",active:true}], handFix: {auto:"hand seal", hold:"holding kunai", hide:"arms crossed"}, negativeAdditions: ["frills", "gun"] },
    { id: "ctx_sengoku", triggers: ["æˆ¦å›½", "æ­¦å°†", "sengoku", "samurai"], tier: 1, tierName: "Sengoku", tags: [{id:"sg1",label:"ç”²å†‘",tag:"japanese armor, kabuto",active:true}], handFix: {auto:"commanding pose", hold:"holding katana", hide:"hands on hips"}, negativeAdditions: ["neon", "robot"] },
    { id: "ctx_horror", triggers: ["å¹½éœŠ", "å‘ªã„", "horror", "ghost"], tier: 2, tierName: "JP Horror", tags: [{id:"hr1",label:"æ­»è£…æŸ",tag:"yurei, white kimono",active:true}], handFix: {auto:"dangling hands", hold:"reaching out", hide:"hands invisible"}, negativeAdditions: ["bikini", "smiling"] },
    { id: "ctx_scifi", triggers: ["å®‡å®™èˆ¹", "SF", "spaceship", "scifi"], tier: 3, tierName: "Sci-Fi Ship", tags: [{id:"sf1",label:"ãƒ—ãƒ©ã‚°ã‚¹ãƒ¼ãƒ„",tag:"plugsuit, futuristic",active:true}], handFix: {auto:"operating console", hold:"holding helmet", hide:"hands behind back"}, negativeAdditions: ["tatami", "nature"] },
    { id: "ctx_elf", triggers: ["ã‚¨ãƒ«ãƒ•", "elf"], tier: 3, tierName: "Fantasy Elf", tags: [{id:"el1",label:"ã‚¨ãƒ«ãƒ•è€³",tag:"pointy ears, elf",active:true}], handFix: {auto:"standing pose", hold:"holding bow", hide:"hands clasped"}, negativeAdditions: ["neon", "gun"] },
    { id: "ctx_steampunk", triggers: ["ã‚¹ãƒãƒ¼ãƒ ãƒ‘ãƒ³ã‚¯", "steampunk"], tier: 3, tierName: "Steampunk", tags: [{id:"sp1",label:"ã‚´ãƒ¼ã‚°ãƒ«",tag:"steampunk, goggles",active:true}], handFix: {auto:"adjusting goggles", hold:"holding wrench", hide:"hands in pockets"}, negativeAdditions: ["neon", "kimono"] },
    { id: "ctx_school", triggers: ["åˆ¶æœ", "ã‚»ãƒ¼ãƒ©ãƒ¼æœ", "school uniform"], tier: 3, tierName: "JP School", tags: [{id:"sch1",label:"ã‚»ãƒ¼ãƒ©ãƒ¼æœ",tag:"school uniform, sailor collar",active:true}], handFix: {auto:"sitting at desk", hold:"holding book", hide:"hands behind back"}, negativeAdditions: ["gun", "armor"] },
    { id: "ctx_cooking", triggers: ["æ–™ç†", "å’Œé£Ÿ", "cooking", "kitchen"], tier: 2, tierName: "Cooking", tags: [{id:"ck1",label:"å‰²çƒ¹ç€",tag:"white apron, chef",active:true}], handFix: {auto:"cooking pose", hold:"holding knife", hide:"hands washing"}, negativeAdditions: ["robot", "gun"] },
    { id: "ctx_calligraphy", triggers: ["æ›¸é“", "ç­†", "å¢¨", "calligraphy"], tier: 1, tierName: "Calligraphy", tags: [{id:"cal1",label:"æ›¸é“",tag:"doing calligraphy, brush",active:true}], handFix: {auto:"writing pose", hold:"holding brush", hide:"hands on lap"}, negativeAdditions: ["gun", "bikini"] }
  ];

  const DEFAULT_DICT = [
    { key: "å·«å¥³", val: "miko, shrine maiden" },
    { key: "å¥³æ€§", val: "1girl, solo" },
    { key: "æŠ¹èŒ¶", val: "matcha, green tea" },
    { key: "æ­£åº§", val: "seiza, kneeling" },
    { key: "ç•³", val: "tatami" },
    { key: "å’Œå®¤", val: "washitsu, japanese room" },
    { key: "èŒ¶å®¤", val: "tea room, chashitsu" }
  ];

  const QUALITY_MAP = {
    standard: "(best quality), (illustration), highly detailed",
    high: "(masterpiece:1.2), (best quality:1.2), 8k, cinematic lighting, highly detailed",
    god: "(masterpiece:1.5), (best quality:1.4), (absurdres:1.2), 8k, perfect anatomy, cinematic composition, soft lighting, depth of field"
  };

  // --- State ---
  let contextDB = JSON.parse(localStorage.getItem("apa_contexts")) || DEFAULT_CONTEXTS;
  let dictDB = JSON.parse(localStorage.getItem("apa_dict")) || DEFAULT_DICT;
  let activeContexts = [];

  // --- Helpers ---
  const $ = id => document.getElementById(id);
  const save = () => {
    localStorage.setItem("apa_contexts", JSON.stringify(contextDB));
    localStorage.setItem("apa_dict", JSON.stringify(dictDB));
  };
  const uniq = arr => [...new Set(arr.filter(Boolean))];

  // --- Logic ---
  function updateContexts() {
    const input = $("core-input").value.toLowerCase();
    const hits = [];
    contextDB.forEach(ctx => {
      const match = ctx.triggers.filter(t => input.includes(t.toLowerCase())).length;
      if (match > 0) hits.push({ ctx, match });
    });
    // Sort by Tier (1 is highest priority), then match count
    hits.sort((a,b) => (a.ctx.tier - b.ctx.tier) || (b.match - a.match));
    activeContexts = hits.map(h => h.ctx);
    
    renderSuggestions();
    renderTierPills();
    updateHandFixHint();
  }

  function renderTierPills() {
    $("tier-display").innerHTML = activeContexts.map(ctx => 
      `<span class="tier-pill tier-${ctx.tier}">Tier ${ctx.tier}: ${ctx.tierName}</span>`
    ).join("");
  }

  function renderSuggestions() {
    const container = $("tag-suggestions");
    container.innerHTML = "";
    if (activeContexts.length === 0) {
      container.innerHTML = '<span class="mini" style="font-style:italic;">No context detected.</span>';
      return;
    }
    const selected = activeContexts[0]; // Priority 1
    selected.tags.forEach(t => {
      const id = `cb-${selected.id}-${t.id}`;
      container.innerHTML += `
        <div>
          <input type="checkbox" id="${id}" class="tag-checkbox" checked data-tag="${t.tag}">
          <label for="${id}" class="tag-label">${t.label}</label>
        </div>
      `;
    });
  }

  function updateHandFixHint() {
    const ctx = activeContexts[0];
    const mode = $("hand-fix-select").value;
    if (mode === "none") { $("hand-fix-hint").textContent = ""; return; }
    const poses = ctx ? (ctx.handFix || {}) : {auto:"hands joined", hold:"holding item", hide:"hands behind back"};
    $("hand-fix-hint").textContent = `Suggested: ${poses[mode] || "Standard pose"}`;
  }

  function generate() {
    const input = $("core-input").value.trim();
    if (!input) { setStatus("Input is empty.", true); return; }

    const qual = QUALITY_MAP[$("quality-select").value];
    const ctx = activeContexts[0];
    
    // Translation Map Logic
    let translatedTags = [];
    dictDB.forEach(item => {
      if (input.includes(item.key)) translatedTags.push(item.val);
    });

    // Checkbox tags
    const checkedTags = Array.from($("tag-suggestions").querySelectorAll("input:checked")).map(el => el.dataset.tag);

    // Hand Fix
    const fixMode = $("hand-fix-select").value;
    let handTag = "";
    if (fixMode !== "none") {
      const poses = ctx ? ctx.handFix : {auto:"hands joined", hold:"holding object", hide:"hands behind back"};
      handTag = poses[fixMode];
    }

    // Build Positive
    let posParts = [qual];
    if (translatedTags.length) posParts.push(translatedTags.join(", "));
    if ($("check-keep-en").checked && /[a-zA-Z]/.test(input)) posParts.push(input);
    if (checkedTags.length) posParts.push(checkedTags.join(", "));
    if (handTag) posParts.push(handTag);

    const positive = uniq(posParts.join(", ").split(",").map(s => s.trim())).join(", ");

    // Build Negative
    let negParts = [$("check-nsfw").checked ? "NSFW, (worst quality:1.4), bad anatomy, (bad hands:1.4), extra fingers" : "(worst quality:1.4), bad anatomy, (bad hands:1.4)"];
    if (ctx && ctx.negativeAdditions) negParts.push(...ctx.negativeAdditions);
    const negative = uniq(negParts.join(", ").split(",").map(s => s.trim())).join(", ");

    $("out-pos").value = positive;
    $("out-neg").value = negative;
    $("stats-info").innerHTML = `<span style="color:var(--success)">Generated!</span> Pos: ${positive.length} / Neg: ${negative.length}`;
    setStatus("Apocrypha Prompt Generated Successfully.");
  }

  function setStatus(msg, warn=false) {
    $("status-bar").textContent = msg;
    $("status-bar").className = warn ? "apocrypha-log warning" : "apocrypha-log";
  }

  // --- Manager UI ---
  function renderContextManager() {
    $("list-ctx").innerHTML = contextDB.map((ctx, i) => `
      <div class="list-item">
        <span><span class="tier-pill tier-${ctx.tier}">T${ctx.tier}</span> ${ctx.tierName}</span>
        <button class="btn-inline" onclick="delCtx(${i})" style="border-color:var(--alert); color:var(--alert);">Del</button>
      </div>
    `).join("");
  }

  function renderDictManager() {
    $("list-dict").innerHTML = dictDB.map((d, i) => `
      <div class="list-item">
        <span><b>${d.key}</b> â†’ ${d.val}</span>
        <button class="btn-inline" onclick="delDict(${i})" style="border-color:var(--alert); color:var(--alert);">Del</button>
      </div>
    `).join("");
  }

  window.delCtx = i => { if(confirm("Delete context?")){ contextDB.splice(i,1); save(); renderContextManager(); updateContexts(); }};
  window.delDict = i => { dictDB.splice(i,1); save(); renderDictManager(); };

  // --- Events ---
  $("core-input").addEventListener("input", updateContexts);
  $("hand-fix-select").addEventListener("change", updateHandFixHint);
  $("btn-generate").addEventListener("click", generate);
  document.addEventListener("keydown", e => { if((e.ctrlKey||e.metaKey)&&e.key==="Enter") generate(); });

  $("btn-add-dict").addEventListener("click", () => {
    const k = $("dict-in-jp").value.trim();
    const v = $("dict-in-en").value.trim();
    if (k && v) { dictDB.push({key:k, val:v}); save(); renderDictManager(); $("dict-in-jp").value=""; $("dict-in-en").value=""; }
  });

  $("btn-export-all").addEventListener("click", () => {
    const data = { contexts: contextDB, dictionary: dictDB, version: 0.8 };
    $("io-json").value = JSON.stringify(data, null, 2);
    setStatus("Data exported to JSON area below.");
  });

  $("btn-import-all").addEventListener("click", () => {
    try {
      const data = JSON.parse($("io-json").value);
      if (data.contexts) contextDB = data.contexts;
      if (data.dictionary) dictDB = data.dictionary;
      save();
      renderContextManager();
      renderDictManager();
      updateContexts();
      alert("Import successful!");
    } catch(e) { alert("Invalid JSON."); }
  });

  $("btn-reset-factory").addEventListener("click", () => {
    if(confirm("Factory reset? All custom data will be lost.")){
      localStorage.clear();
      location.reload();
    }
  });

  // Tab Logic
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll(".tab-btn, .tab-content").forEach(el => el.classList.remove("active"));
      btn.classList.add("active");
      $(btn.dataset.tab).classList.add("active");
    };
  });

  // Copy
  document.querySelectorAll(".copy-btn").forEach(btn => {
    btn.onclick = () => {
      const target = $(btn.dataset.target);
      target.select();
      document.execCommand("copy");
      const old = btn.textContent;
      btn.textContent = "COPIED!";
      btn.classList.add("copied");
      setTimeout(() => { btn.textContent = old; btn.classList.remove("copied"); }, 1200);
    };
  });

  // Start
  renderContextManager();
  renderDictManager();
  updateContexts();

</script>
</body>
</html>
